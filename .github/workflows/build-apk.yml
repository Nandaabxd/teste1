name: üöÄ Build NFC Writer PRO2 APK
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üîß Setup Environment
      run: |
        echo "üîß Configurando ambiente Ubuntu..."
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          build-essential \
          git \
          unzip \
          zip \
          curl \
          wget
        echo "‚úÖ Ambiente configurado!"
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ‚òï Setup Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: üì¶ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
          
    - name: üîß Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-wheel \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          ccache
          
    - name: üì± Install Android SDK
      uses: android-actions/setup-android@v3
      env:
        SKIP_JDK_VERSION_CHECK: true
        
    - name: üîê Accept Android SDK Licenses
      run: |
        echo "üîê Aceitando licen√ßas do Android SDK..."
        
        # Criar diret√≥rio de licen√ßas
        mkdir -p $ANDROID_SDK_ROOT/licenses
        
        # Aceitar TODAS as licen√ßas conhecidas do Android SDK
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        
        # Licen√ßas espec√≠ficas para build-tools mais recentes
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
        echo "504667f4c0de7af1a06de9f4b1727b84351f2910" >> $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
        
        # Licen√ßas adicionais
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_SDK_ROOT/licenses/intel-android-extra-license
        echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_SDK_ROOT/licenses/google-gdk-license
        echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" >> $ANDROID_SDK_ROOT/licenses/google-gdk-license
        
        # Aceitar licen√ßas via m√∫ltiplos m√©todos
        echo "üîÑ M√©todo 1: Aceitar via yes..."
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses 2>/dev/null || true
        
        echo "üîÑ M√©todo 2: Aceitar via printf..."
        printf "y\n%.0s" {1..50} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses 2>/dev/null || true
        
        echo "üîÑ M√©todo 3: Aceitar com timeout..."
        timeout 60s bash -c 'printf "y\n%.0s" {1..50} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses' 2>/dev/null || true
        
        echo "‚úÖ Licen√ßas configuradas!"
      env:
        SKIP_JDK_VERSION_CHECK: true
        
    - name: üõ†Ô∏è Install Build Tools
      run: |
        echo "üõ†Ô∏è Instalando build-tools..."
        
        # Aceitar licen√ßas mais agressivamente
        echo "üîê For√ßando aceita√ß√£o de licen√ßas..."
        mkdir -p $ANDROID_SDK_ROOT/licenses
        
        # Todas as licen√ßas conhecidas (m√©todo mais direto)
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "504667f4c0de7af1a06de9f4b1727b84351f2910" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        
        # Aceitar via m√∫ltiplos m√©todos
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses 2>/dev/null || true
        printf "y\n%.0s" {1..100} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses 2>/dev/null || true
        
        # Instalar APENAS vers√µes est√°veis e testadas
        echo "üì¶ Instalando build-tools est√°veis..."
        
        # For√ßar instala√ß√£o com m√∫ltiplas tentativas
        for version in "33.0.2" "34.0.0" "33.0.1" "35.0.0"; do
          echo "üîÑ Tentando instalar build-tools;$version..."
          printf "y\n%.0s" {1..50} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;$version" 2>/dev/null || true
        done
        
        # Instalar platform-tools
        echo "üì¶ Instalando platform-tools..."
        printf "y\n%.0s" {1..50} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" 2>/dev/null || true
        
        # Instalar plataforma Android API 33
        echo "üì¶ Instalando platforms;android-33..."
        printf "y\n%.0s" {1..50} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-33" 2>/dev/null || true
        
        # Verificar o que foi instalado
        echo "üîç Verificando instala√ß√µes:"
        ls -la $ANDROID_SDK_ROOT/build-tools/ 2>/dev/null || echo "Build-tools n√£o encontrado"
        ls -la $ANDROID_SDK_ROOT/platform-tools/ 2>/dev/null || echo "Platform-tools n√£o encontrado"
        
        # Procurar AIDL em build-tools
        echo "üîç Procurando AIDL:"
        find $ANDROID_SDK_ROOT/build-tools -name "aidl" -type f 2>/dev/null || echo "AIDL n√£o encontrado em build-tools"
        
        # Configurar PATH para a vers√£o mais recente
        if [ -d "$ANDROID_SDK_ROOT/build-tools" ]; then
          LATEST_BUILD_TOOLS=$(ls $ANDROID_SDK_ROOT/build-tools/ | sort -V | tail -1)
          echo "üéØ Usando build-tools: $LATEST_BUILD_TOOLS"
          echo "PATH=$ANDROID_SDK_ROOT/build-tools/$LATEST_BUILD_TOOLS:$PATH" >> $GITHUB_ENV
          echo "‚úÖ Build-tools $LATEST_BUILD_TOOLS adicionadas ao PATH"
        fi
        
        # Adicionar platform-tools ao PATH
        if [ -d "$ANDROID_SDK_ROOT/platform-tools" ]; then
          echo "PATH=$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV
          echo "‚úÖ Platform-tools adicionadas ao PATH"
        fi
        
        echo "‚úÖ Build-tools configuradas!"
      env:
        SKIP_JDK_VERSION_CHECK: true
        
    - name: üîß Setup AIDL and Fix Buildozer
      run: |
        echo "üîç Configurando AIDL e corrigindo Buildozer..."
        
        # Verificar se AIDL est√° dispon√≠vel
        echo "üîç Procurando AIDL em todas as build-tools:"
        find $ANDROID_SDK_ROOT/build-tools -name "aidl" -type f 2>/dev/null || echo "Nenhum AIDL encontrado ainda"
        
        # Se n√£o encontrou AIDL, instalar uma vers√£o mais antiga que sabemos que funciona
        if ! find $ANDROID_SDK_ROOT/build-tools -name "aidl" -type f 2>/dev/null | grep -q aidl; then
          echo "‚ö†Ô∏è AIDL n√£o encontrado, instalando vers√£o mais antiga..."
          printf "y\n%.0s" {1..50} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;30.0.3" 2>/dev/null || true
          printf "y\n%.0s" {1..50} | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;31.0.0" 2>/dev/null || true
        fi
        
        # Procurar AIDL novamente
        echo "üîç Procurando AIDL ap√≥s instala√ß√£o:"
        AIDL_PATH=$(find $ANDROID_SDK_ROOT/build-tools -name "aidl" -type f 2>/dev/null | head -1)
        
        if [ -n "$AIDL_PATH" ]; then
          echo "‚úÖ AIDL encontrado em: $AIDL_PATH"
          AIDL_DIR=$(dirname "$AIDL_PATH")
          echo "PATH=$AIDL_DIR:$PATH" >> $GITHUB_ENV
          echo "‚úÖ AIDL adicionado ao PATH"
        else
          echo "‚ö†Ô∏è AIDL ainda n√£o encontrado, continuando..."
        fi
        
        # Configurar PATH para build-tools com AIDL
        if [ -d "$ANDROID_SDK_ROOT/build-tools" ]; then
          for bt_version in $(ls $ANDROID_SDK_ROOT/build-tools/ | sort -V -r); do
            if [ -f "$ANDROID_SDK_ROOT/build-tools/$bt_version/aidl" ]; then
              echo "‚úÖ AIDL encontrado em build-tools: $bt_version"
              echo "PATH=$ANDROID_SDK_ROOT/build-tools/$bt_version:$PATH" >> $GITHUB_ENV
              
              # Criar link simb√≥lico para buildozer encontrar
              sudo ln -sf "$ANDROID_SDK_ROOT/build-tools/$bt_version" "$ANDROID_SDK_ROOT/build-tools/android-sdk" 2>/dev/null || true
              break
            fi
          done
        fi
        
        # Copiar build-tools para o diret√≥rio do buildozer
        echo "üîÑ Copiando build-tools para buildozer..."
        mkdir -p ~/.buildozer/android/platform/android-sdk/build-tools
        if [ -d "$ANDROID_SDK_ROOT/build-tools" ]; then
          cp -r $ANDROID_SDK_ROOT/build-tools/* ~/.buildozer/android/platform/android-sdk/build-tools/ 2>/dev/null || true
        fi
        
        # Verificar se AIDL est√° acess√≠vel para buildozer
        echo "üîç Verificando AIDL para buildozer:"
        find ~/.buildozer/android/platform/android-sdk/build-tools -name "aidl" -type f 2>/dev/null || echo "AIDL n√£o encontrado no local do buildozer"
        
        # Teste final do AIDL
        echo "üîç Teste final do AIDL:"
        which aidl && echo "‚úÖ AIDL dispon√≠vel no PATH" || echo "‚ö†Ô∏è AIDL n√£o encontrado no PATH"
        
        # Listar todos os AIDLs dispon√≠veis
        echo "üìã Todos os AIDLs encontrados:"
        find $ANDROID_SDK_ROOT -name "aidl" -type f 2>/dev/null | head -10
        
        echo "‚úÖ AIDL configurado!"

    - name: üõ†Ô∏è Install Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install buildozer==1.5.0
        pip install cython==0.29.33
        pip install colorama
        pip install appdirs
        pip install sh
        pip install pexpect
        
    - name: üîß Configure Buildozer
      run: |
        # Verificar se buildozer.spec existe
        if [ ! -f "buildozer.spec" ]; then
          echo "‚ùå buildozer.spec n√£o encontrado!"
          exit 1
        fi
        
        # Criar backup e configurar
        cp buildozer.spec buildozer.spec.backup
        
        # Configura√ß√µes cr√≠ticas para evitar problemas de licen√ßa
        echo "" >> buildozer.spec
        echo "# Configura√ß√µes GitHub Actions - For√ßar vers√µes espec√≠ficas" >> buildozer.spec
        echo "android.build_tools = 33.0.2" >> buildozer.spec
        echo "android.api = 33" >> buildozer.spec
        echo "android.minapi = 21" >> buildozer.spec
        echo "android.ndk = 25b" >> buildozer.spec
        
        # Configura√ß√µes espec√≠ficas para resolver problemas do AIDL
        echo "android.sdk_path = $ANDROID_SDK_ROOT" >> buildozer.spec
        echo "android.ndk_path = $ANDROID_NDK_ROOT" >> buildozer.spec
        
        # FOR√áAR buildozer a usar SDK existente (n√£o baixar novamente)
        echo "android.skip_update = True" >> buildozer.spec
        echo "android.accept_sdk_license = True" >> buildozer.spec
        
        # Configurar git
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # Criar diret√≥rios necess√°rios para buildozer
        mkdir -p ~/.buildozer/cache
        mkdir -p ~/.local/share/python-for-android
        
        # FOR√áAR buildozer a usar o SDK que preparamos
        echo "üîÑ Configurando buildozer para usar SDK pr√©-instalado..."
        
        # Remover qualquer SDK antigo do buildozer
        rm -rf ~/.buildozer/android/platform/android-sdk 2>/dev/null || true
        
        # Criar link simb√≥lico direto para o SDK correto
        mkdir -p ~/.buildozer/android/platform/
        ln -sf $ANDROID_SDK_ROOT ~/.buildozer/android/platform/android-sdk
        
        # Verificar se o link foi criado corretamente
        if [ -L ~/.buildozer/android/platform/android-sdk ]; then
          echo "‚úÖ Link simb√≥lico criado: ~/.buildozer/android/platform/android-sdk -> $ANDROID_SDK_ROOT"
          ls -la ~/.buildozer/android/platform/android-sdk/cmdline-tools/
        else
          echo "‚ùå Falha ao criar link simb√≥lico, copiando SDK..."
          cp -r $ANDROID_SDK_ROOT ~/.buildozer/android/platform/android-sdk/
        fi
        
        # Criar link para NDK
        rm -rf ~/.buildozer/android/platform/android-ndk 2>/dev/null || true
        ln -sf $ANDROID_NDK_ROOT ~/.buildozer/android/platform/android-ndk
        
        # Configurar vari√°veis de ambiente para buildozer
        echo "ANDROIDSDK=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROIDNDK=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "ANDROIDAPI=33" >> $GITHUB_ENV
        echo "ANDROIDMINAPI=21" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
        # Configurar vari√°veis espec√≠ficas para Java 17 compatibility
        echo "SKIP_JDK_VERSION_CHECK=true" >> $GITHUB_ENV
        
        # Verificar estrutura final
        echo "üîç Verificando estrutura buildozer:"
        ls -la ~/.buildozer/android/platform/android-sdk/cmdline-tools/ 2>/dev/null || echo "Cmdline-tools n√£o encontrado"
        ls -la ~/.buildozer/android/platform/android-sdk/build-tools/ 2>/dev/null || echo "Build-tools n√£o encontrado"
        find ~/.buildozer/android/platform/android-sdk/build-tools -name "aidl" -type f 2>/dev/null || echo "AIDL n√£o encontrado"
        
        echo "‚úÖ Buildozer configurado para usar SDK pr√©-instalado!"
        
    - name: üìã Show Build Info
      run: |
        echo "üîç Informa√ß√µes do ambiente:"
        echo "Python: $(python --version)"
        echo "Java: $(java -version 2>&1 | head -1)"
        echo "Buildozer: $(buildozer version)"
        echo "SDK: $ANDROID_SDK_ROOT"
        echo "NDK: $ANDROID_NDK_ROOT"
        echo "JAVA_HOME: $JAVA_HOME"
        
        echo "üîç AIDL status:"
        which aidl && echo "‚úÖ AIDL dispon√≠vel" || echo "‚ö†Ô∏è AIDL n√£o encontrado"
        
        echo "üîç Verificando SDKs dispon√≠veis:"
        ls -la ~/.buildozer/android/platform/android-sdk/cmdline-tools/ 2>/dev/null || echo "Cmdline-tools n√£o encontrado"
        
        echo "üîç Configura√ß√µes do buildozer.spec:"
        tail -10 buildozer.spec
        
    - name: üèóÔ∏è Build APK
      run: |
        echo "üöÄ Iniciando compila√ß√£o do APK..."
        echo "üì± App: NFC Writer PRO2 v2.0"
        echo "üéØ Target: Android API 33"
        echo "‚òï Java: $(java -version 2>&1 | head -1)"
        
        # Garantir que Java 17 seja usado com compatibilidade
        export JAVA_HOME=$JAVA_HOME
        export PATH=$JAVA_HOME/bin:$PATH
        export SKIP_JDK_VERSION_CHECK=true
        
        # Verificar Java novamente
        echo "üîç Verificando Java antes da compila√ß√£o:"
        java -version
        
        # Compilar APK com verbose para debug
        buildozer android debug --verbose
      env:
        SKIP_JDK_VERSION_CHECK: true
        
    - name: üì± Verify APK
      run: |
        echo "üîç Verificando APK gerado..."
        
        if [ -d "bin" ] && [ -n "$(find bin -name "*.apk" 2>/dev/null)" ]; then
          echo "‚úÖ APK gerado com sucesso!"
          APK_FILE=$(find bin -name "*.apk" | head -1)
          echo "üì± Arquivo: $APK_FILE"
          echo "üìä Tamanho: $(du -h "$APK_FILE" | cut -f1)"
          ls -la "$APK_FILE"
        else
          echo "‚ùå APK n√£o foi gerado!"
          echo "üîç Logs de erro:"
          if [ -f ".buildozer/logs/buildozer.log" ]; then
            tail -50 .buildozer/logs/buildozer.log
          fi
          exit 1
        fi
        
    - name: üì§ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: nfc-writer-pro2-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: üéâ Success Notification
      if: success()
      run: |
        echo "üéâ =================================="
        echo "üéâ   COMPILA√á√ÉO CONCLU√çDA COM SUCESSO!"
        echo "üéâ =================================="
        echo ""
        echo "üì± Seu APK est√° pronto!"
        echo "üì• Download: Na aba 'Actions' > 'Artifacts'"
        echo ""
        echo "‚ú® Parab√©ns! Seu app NFC est√° funcionando!"
