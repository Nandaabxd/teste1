name: ðŸš€ Build NFC Writer PRO2 APK
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
          
    - name: ðŸ”§ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-wheel \
          openjdk-17-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          ccache \
          unzip \
          zip
          
    - name: ðŸ“± Install Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        ndk-version: '25.2.9519653'
        
    - name: ðŸ” Accept Android SDK Licenses
      run: |
        echo "ðŸ” Aceitando licenÃ§as do Android SDK..."
        
        # Criar diretÃ³rio de licenÃ§as se nÃ£o existir
        mkdir -p $ANDROID_SDK_ROOT/licenses
        
        # Aceitar todas as licenÃ§as automaticamente (incluindo build-tools 36)
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_SDK_ROOT/licenses/intel-android-extra-license
        echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_SDK_ROOT/licenses/google-gdk-license
        echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > $ANDROID_SDK_ROOT/licenses/google-gdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        
        # LicenÃ§as para build-tools 36 e outras versÃµes
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_SDK_ROOT/licenses/intel-android-extra-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        
        # Aceitar automaticamente usando yes
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # Verificar se as licenÃ§as foram aceitas
        ls -la $ANDROID_SDK_ROOT/licenses/
        
        echo "âœ… LicenÃ§as aceitas automaticamente!"
        
    - name: ðŸ› ï¸ Install Required Build Tools
      run: |
        echo "ðŸ› ï¸ Instalando build-tools necessÃ¡rias..."
        
        # Aceitar licenÃ§as primeiro
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
        
        # Listar o que estÃ¡ disponÃ­vel
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list | grep build-tools
        
        # Instalar mÃºltiplas versÃµes de build-tools para garantir compatibilidade
        echo "ðŸ“¦ Instalando build-tools versÃ£o 33..."
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.0"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.1"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2"
        
        echo "ðŸ“¦ Instalando build-tools versÃ£o 34..."
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0" || true
        
        echo "ðŸ“¦ Tentando instalar build-tools versÃ£o 36..."
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;36.0.0" || echo "âš ï¸ Build-tools 36 nÃ£o disponÃ­vel, usando versÃ£o 33"
        
        # Verificar o que foi instalado
        echo "ðŸ” Build-tools instaladas:"
        ls -la $ANDROID_SDK_ROOT/build-tools/ || echo "âŒ DiretÃ³rio build-tools nÃ£o encontrado"
        
        # Procurar por AIDL em todas as versÃµes instaladas
        echo "ðŸ” Procurando por AIDL:"
        find $ANDROID_SDK_ROOT -name "aidl" -type f 2>/dev/null || echo "âŒ AIDL nÃ£o encontrado"
        
        # Encontrar a versÃ£o mais recente das build-tools instaladas
        LATEST_BUILD_TOOLS=$(ls $ANDROID_SDK_ROOT/build-tools/ | sort -V | tail -1)
        echo "ðŸŽ¯ Usando build-tools: $LATEST_BUILD_TOOLS"
        
        # Adicionar build-tools ao PATH (usar a versÃ£o mais recente disponÃ­vel)
        if [ -d "$ANDROID_SDK_ROOT/build-tools/$LATEST_BUILD_TOOLS" ]; then
          echo "PATH=$ANDROID_SDK_ROOT/build-tools/$LATEST_BUILD_TOOLS:\$PATH" >> $GITHUB_ENV
          echo "âœ… Build-tools $LATEST_BUILD_TOOLS adicionadas ao PATH"
        else
          echo "âŒ Erro: build-tools nÃ£o encontradas"
          exit 1
        fi
        
        echo "âœ… Build-tools configuradas com sucesso!"
        
    - name: ðŸ”§ Verify and Fix AIDL
      run: |
        echo "ðŸ” Verificando AIDL..."
        
        # Procurar AIDL em todo o Android SDK
        AIDL_PATH=$(find $ANDROID_SDK_ROOT -name "aidl" -type f 2>/dev/null | head -1)
        
        if [ -n "$AIDL_PATH" ]; then
          echo "âœ… AIDL encontrado: $AIDL_PATH"
          
          # Verificar se o AIDL Ã© executÃ¡vel
          if [ -x "$AIDL_PATH" ]; then
            echo "âœ… AIDL Ã© executÃ¡vel"
            $AIDL_PATH --help || echo "AIDL funciona mas sem --help"
          else
            echo "âš ï¸ AIDL nÃ£o Ã© executÃ¡vel, corrigindo..."
            chmod +x "$AIDL_PATH"
          fi
          
          # Adicionar diretÃ³rio do AIDL ao PATH
          AIDL_DIR=$(dirname "$AIDL_PATH")
          echo "PATH=$AIDL_DIR:\$PATH" >> $GITHUB_ENV
          echo "âœ… AIDL adicionado ao PATH: $AIDL_DIR"
          
        else
          echo "âŒ AIDL nÃ£o encontrado!"
          echo "ðŸ” Listando conteÃºdo das build-tools:"
          find $ANDROID_SDK_ROOT/build-tools -type f -name "*aidl*" 2>/dev/null || echo "Nenhum arquivo aidl encontrado"
          
          echo "ðŸ“¦ Tentando instalar platform-tools que contÃ©m AIDL..."
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools"
          
          # Procurar novamente
          AIDL_PATH=$(find $ANDROID_SDK_ROOT -name "aidl" -type f 2>/dev/null | head -1)
          if [ -n "$AIDL_PATH" ]; then
            echo "âœ… AIDL encontrado apÃ³s instalar platform-tools: $AIDL_PATH"
            chmod +x "$AIDL_PATH"
            AIDL_DIR=$(dirname "$AIDL_PATH")
            echo "PATH=$AIDL_DIR:\$PATH" >> $GITHUB_ENV
          else
            echo "âŒ AIDL ainda nÃ£o encontrado mesmo apÃ³s instalar platform-tools"
            echo "ðŸ” Estrutura do SDK:"
            ls -la $ANDROID_SDK_ROOT/
            echo "ðŸ” ConteÃºdo de build-tools:"
            ls -la $ANDROID_SDK_ROOT/build-tools/ || echo "build-tools nÃ£o existe"
            echo "ðŸ” ConteÃºdo de platform-tools:"
            ls -la $ANDROID_SDK_ROOT/platform-tools/ || echo "platform-tools nÃ£o existe"
          fi
        fi
        
    - name: ðŸ› ï¸ Install Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install buildozer==1.5.0
        pip install cython==0.29.33
        pip install colorama
        pip install appdirs
        pip install sh
        pip install pexpect
        
    - name: ðŸ”§ Fix Buildozer Issues
      run: |
        # Corrigir problemas comuns do buildozer
        echo "ðŸ”§ Aplicando correÃ§Ãµes..."
        
        # Verificar se buildozer.spec existe
        if [ ! -f "buildozer.spec" ]; then
          echo "âŒ buildozer.spec nÃ£o encontrado!"
          exit 1
        fi
        
        # Instalar dependÃªncias adicionais que podem estar faltando
        sudo apt-get install -y \
          libc6-dev \
          libffi-dev \
          libssl-dev \
          python3-distutils \
          python3-venv || true
        
        # Criar diretÃ³rios necessÃ¡rios
        mkdir -p ~/.buildozer/cache
        mkdir -p ~/.local/share/python-for-android
        
        # Configurar git (necessÃ¡rio para algumas dependÃªncias)
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # Limpar cache se necessÃ¡rio
        buildozer android clean || true
        
    - name: ðŸ“‹ Show Build Info
      run: |
        echo "ðŸ” Environment Info:"
        echo "Python: $(python --version)"
        echo "Java: $(java -version)"
        echo "Buildozer: $(buildozer version)"
        echo "NDK: $ANDROID_NDK_ROOT"
        echo "SDK: $ANDROID_SDK_ROOT"
        
    - name: ðŸ”§ Configure Buildozer
      run: |
        # Criar diretÃ³rio .buildozer se nÃ£o existir
        mkdir -p ~/.buildozer
        
        # Configurar variÃ¡veis de ambiente
        export ANDROIDSDK="$ANDROID_SDK_ROOT"
        export ANDROIDNDK="$ANDROID_NDK_ROOT"
        export ANDROIDAPI="33"
        export ANDROIDMINAPI="21"
        
        echo "SDK Path: $ANDROIDSDK"
        echo "NDK Path: $ANDROIDNDK"
        
        # Verificar e ajustar buildozer.spec para usar build-tools corretas
        if [ -f "buildozer.spec" ]; then
          echo "ðŸ”§ Ajustando buildozer.spec..."
          
          # ForÃ§ar uso de build-tools 33 se estiver configurado para 36
          sed -i 's/android.gradle_dependencies = .*/android.gradle_dependencies = /g' buildozer.spec || true
          sed -i 's/android.build_tools = .*/android.build_tools = 33.0.2/g' buildozer.spec || true
          
          # Adicionar configuraÃ§Ã£o de build-tools se nÃ£o existir
          if ! grep -q "android.build_tools" buildozer.spec; then
            echo "android.build_tools = 33.0.2" >> buildozer.spec
          fi
          
          echo "âœ… buildozer.spec ajustado para usar build-tools 33.0.2"
        fi
        
        # ForÃ§ar instalaÃ§Ã£o de dependÃªncias que podem faltar
        pip install --upgrade cython==0.29.33
        pip install --upgrade pyjnius
        
    - name: ðŸ” Pre-Build Diagnostics
      run: |
        echo "ðŸ” DiagnÃ³stico prÃ©-build:"
        echo "Working directory: $(pwd)"
        echo "Files present:"
        ls -la
        echo ""
        echo "ðŸ”§ buildozer.spec content (first 40 lines):"
        head -40 buildozer.spec
        echo ""
        echo "ðŸ Python packages installed:"
        pip list | grep -E "(buildozer|cython|pyjnius|kivy)"
        echo ""
        echo "ðŸŒ Environment variables:"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
        echo "PATH: $PATH"
        echo ""
        echo "ðŸ“± Android SDK structure:"
        ls -la $ANDROID_SDK_ROOT/ || echo "SDK root nÃ£o encontrado"
        echo ""
        echo "ðŸ› ï¸ Build-tools disponÃ­veis:"
        ls -la $ANDROID_SDK_ROOT/build-tools/ || echo "Build-tools nÃ£o encontrado"
        echo ""
        echo "ðŸ” AIDL verification:"
        which aidl || echo "AIDL nÃ£o estÃ¡ no PATH"
        find $ANDROID_SDK_ROOT -name "aidl" -type f 2>/dev/null || echo "AIDL nÃ£o encontrado no SDK"
        echo ""
        echo "ðŸ“‹ Buildozer version and config:"
        buildozer version
        buildozer android debug --verbose --dry-run 2>&1 | head -20 || echo "Erro no dry-run"
        
    - name: ðŸ—ï¸ Build APK
      run: |
        echo "ðŸš€ Iniciando compilaÃ§Ã£o do APK..."
        echo "ðŸ“± App: NFC Writer PRO2 v2.0"
        echo "ðŸŽ¯ Target: Android API 33"
        echo "ðŸ“ Arch: ARM 32/64-bit"
        
        # Debug info antes do build
        echo "ðŸ” Debug info:"
        ls -la
        cat buildozer.spec | head -20
        
        # Compilar APK com debug verbose
        buildozer android debug --verbose
        
    - name: ðŸ“± Verify APK
      run: |
        echo "ðŸ” Verificando APK gerado..."
        ls -la bin/ || echo "âŒ DiretÃ³rio bin/ nÃ£o existe"
        
        # Verificar se algum APK foi gerado
        find . -name "*.apk" -type f || echo "âŒ Nenhum APK encontrado"
        
        if [ -d "bin" ] && [ -n "$(ls -A bin/*.apk 2>/dev/null)" ]; then
          echo "âœ… APK gerado com sucesso!"
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "ðŸ“± Arquivo: $APK_FILE"
          echo "ðŸ“Š Tamanho: $(du -h $APK_FILE | cut -f1)"
          
          # Verificar estrutura do APK
          file $APK_FILE
        else
          echo "âŒ APK nÃ£o foi gerado!"
          echo "ðŸ” Verificando logs de erro..."
          if [ -f ".buildozer/logs/buildozer.log" ]; then
            echo "ðŸ“‹ Ãšltimas linhas do log:"
            tail -50 .buildozer/logs/buildozer.log
          fi
          exit 1
        fi
        
    - name: ðŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: nfc-writer-pro2-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: ðŸ“‹ Create Release Notes
      if: success()
      run: |
        echo "ðŸŽ‰ **NFC Writer PRO2 v2.0 - APK Gerado com Sucesso!**" > release_notes.md
        echo "" >> release_notes.md
        echo "### ðŸ“± **InformaÃ§Ãµes do APK:**" >> release_notes.md
        echo "- **App**: NFC Writer PRO2" >> release_notes.md
        echo "- **VersÃ£o**: 2.0" >> release_notes.md
        echo "- **Android Min**: API 21 (Android 5.0)" >> release_notes.md
        echo "- **Android Target**: API 33 (Android 13)" >> release_notes.md
        echo "- **Arquitetura**: ARM 32/64-bit" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ðŸ” **Funcionalidades:**" >> release_notes.md
        echo "- âœ… Leitura de tags NFC" >> release_notes.md
        echo "- âœ… Escrita de tags NFC (10 tipos)" >> release_notes.md
        echo "- âœ… Interface moderna e intuitiva" >> release_notes.md
        echo "- âœ… HistÃ³rico de leituras" >> release_notes.md
        echo "- âœ… ValidaÃ§Ã£o de dados" >> release_notes.md
        echo "- âœ… Preview antes de escrever" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ðŸ“¥ **Como usar:**" >> release_notes.md
        echo "1. Baixe o APK dos artifacts acima" >> release_notes.md
        echo "2. Habilite 'Fontes Desconhecidas' no Android" >> release_notes.md
        echo "3. Instale o APK" >> release_notes.md
        echo "4. Teste com tags NFC!" >> release_notes.md
        
        cat release_notes.md
        
    - name: ðŸ“¤ Upload Release Notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: release_notes.md
        retention-days: 30

    - name: ðŸŽ‰ Success Notification
      if: success()
      run: |
        echo "ðŸŽ‰ =================================="
        echo "ðŸŽ‰   COMPILAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!"
        echo "ðŸŽ‰ =================================="
        echo ""
        echo "ðŸ“± Seu APK estÃ¡ pronto!"
        echo "ðŸ“¥ Download: Na aba 'Actions' > 'Artifacts'"
        echo ""
        echo "ðŸš€ PrÃ³ximos passos:"
        echo "   1. Baixe o APK"
        echo "   2. Instale no celular"
        echo "   3. Teste com tags NFC"
        echo ""
        echo "âœ¨ ParabÃ©ns! Seu app NFC estÃ¡ funcionando!"
